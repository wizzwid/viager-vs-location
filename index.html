<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Viager vs Location</title>
    <link rel="manifest" href="/viager-vs-location/manifest.json" />

    <!-- === Consentement & Google Analytics 4 === -->
    <style>
      /* Bandeau de consentement minimal */
      #cookie-banner {
        position: fixed; left: 0; right: 0; bottom: 0;
        padding: 12px 16px; background: #111; color: #fff;
        display: none; z-index: 9999;
        font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }
      #cookie-banner .btns { display:inline-flex; gap: 8px; margin-left: 12px; }
      #cookie-banner button {
        border: 0; padding: 8px 12px; cursor: pointer; border-radius: 6px;
      }
      #cookie-accept { background:#2ea44f; color:#fff; }
      #cookie-reject { background:#444; color:#fff; }
    </style>

    <script>
      (function () {
        // ---- ID Google Analytics 4 ----
        var GA_MEASUREMENT_ID = 'G-GSTWDG9DLW';

        var KEY = 'cookie_consent';
        var consent = localStorage.getItem(KEY);

        // Fonction d’injection du script GA4 après consentement
        function loadGA() {
          var s = document.createElement('script');
          s.async = true;
          s.src = "https://www.googletagmanager.com/gtag/js?id=" + GA_MEASUREMENT_ID;
          document.head.appendChild(s);

          window.dataLayer = window.dataLayer || [];
          function gtag(){ dataLayer.push(arguments); }
          window.gtag = gtag;

          gtag('js', new Date());
          gtag('config', GA_MEASUREMENT_ID, {
            anonymize_ip: true,
            send_page_view: false
          });

          // Tracking SPA (React Router)
          function sendPageView() {
            const path = location.pathname + location.search + location.hash;
            gtag('event', 'page_view', {
              page_location: location.href,
              page_path: path,
              page_title: document.title || 'Viager vs Location'
            });
          }
          sendPageView();

          const _push = history.pushState;
          const _replace = history.replaceState;
          history.pushState = function() { _push.apply(this, arguments); setTimeout(sendPageView, 0); };
          history.replaceState = function() { _replace.apply(this, arguments); setTimeout(sendPageView, 0); };
          window.addEventListener('popstate', sendPageView);
        }

        function showBanner() {
          const b = document.getElementById('cookie-banner');
          if (b) b.style.display = 'block';
        }
        function hideBanner() {
          const b = document.getElementById('cookie-banner');
          if (b) b.style.display = 'none';
        }

        if (consent === 'yes') {
          loadGA();
        } else if (consent === null) {
          document.addEventListener('DOMContentLoaded', showBanner);
        }

        window.__cookieAccept = function() {
          localStorage.setItem(KEY, 'yes');
          hideBanner();
          loadGA();
        };
        window.__cookieReject = function() {
          localStorage.setItem(KEY, 'no');
          hideBanner();
        };
      })();
    </script>
    <!-- === Fin GA4 === -->
  </head>

  <body>
    <!-- Bandeau de consentement -->
    <div id="cookie-banner" role="dialog" aria-live="polite">
      Nous utilisons des cookies de mesure d’audience (Google Analytics) pour améliorer le site.
      <div class="btns">
        <button id="cookie-accept" onclick="__cookieAccept()">Accepter</button>
        <button id="cookie-reject" onclick="__cookieReject()">Refuser</button>
      </div>
    </div>

    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
